<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ultimate Typing Practice Tutor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap">
  <style>
    :root {
      --main-bg: #f4f4f4;
      --main-fg: #222;
      --accent: #1976d2;
      --error: #e53935;
      --success: #43a047;
      --kbd-bg: #fff;
      --kbd-fg: #222;
      --kbd-highlight: #ffd600;
      --kbd-next: #1976d2;
      --kbd-correct: #43a047;
      --kbd-wrong: #e53935;
      --kbd-border: #bbb;
      --panel-bg: #fff;
      --panel-fg: #222;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --kbd-size: 1.2em;
      --kbd-radius: 8px;
      --kbd-gap: 4px;
      --kbd-padding: 12px;
      --kbd-width: 44px;
      --kbd-height: 44px;
      --font-size: 1.1em;
      --zoom: 1;
    }
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: var(--main-bg);
      color: var(--main-fg);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
      font-size: var(--font-size);
      zoom: var(--zoom);
      overflow-x: hidden;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: var(--panel-bg);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .header .logo {
      font-weight: bold;
      font-size: 1.3em;
      letter-spacing: 2px;
      color: var(--accent);
    }
    .header .controls {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .header button, .header .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      color: var(--main-fg);
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .header button:hover, .header .icon-btn:hover {
      background: #eee;
    }
    .main {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 24px;
      margin-bottom: 24px;
    }
    .typing-box {
      width: 90vw;
      max-width: 700px;
      min-width: 250px;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .typing-text {
      font-size: 1.3em;
      min-height: 2.2em;
      margin-bottom: 12px;
      word-break: break-all;
      letter-spacing: 1px;
      user-select: none;
      width: 100%;
      text-align: left;
    }
    .typing-text span {
      transition: color 0.2s, background 0.2s;
      padding: 2px 1px;
      border-radius: 3px;
    }
    .typing-text .correct {
      color: var(--success);
    }
    .typing-text .wrong {
      color: var(--error);
      background: #ffeaea;
    }
    .typing-text .current {
      background: var(--kbd-highlight);
      color: var(--main-fg);
    }
    .typing-input {
      opacity: 0;
      position: absolute;
      left: -9999px;
    }
    .stats {
      display: flex;
      gap: 18px;
      margin-bottom: 10px;
      font-size: 1em;
      width: 100%;
      justify-content: space-between;
    }
    .stats span {
      min-width: 80px;
      text-align: center;
    }
    .actions {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      width: 100%;
      justify-content: flex-end;
    }
    .actions button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    .actions button:hover {
      background: #125ea7;
    }
    .keyboard-container {
      margin-top: 18px;
      margin-bottom: 18px;
      width: 100vw;
      max-width: 900px;
      overflow-x: auto;
      display: flex;
      justify-content: center;
    }
    .keyboard {
      display: flex;
      flex-direction: column;
      gap: var(--kbd-gap);
      align-items: center;
      user-select: none;
      font-size: var(--kbd-size);
      transition: font-size 0.2s;
    }
    .keyboard-row {
      display: flex;
      gap: var(--kbd-gap);
    }
    .key {
      width: var(--kbd-width);
      height: var(--kbd-height);
      background: var(--kbd-bg);
      color: var(--kbd-fg);
      border: 1.5px solid var(--kbd-border);
      border-radius: var(--kbd-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1px;
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      transition: background 0.2s, color 0.2s, border 0.2s;
      position: relative;
      cursor: pointer;
      user-select: none;
    }
    .key.next {
      background: var(--kbd-next);
      color: #fff;
      border-color: var(--accent);
      font-weight: bold;
      animation: pulse 1s infinite alternate;
    }
    .key.highlight {
      background: var(--kbd-highlight);
      color: var(--main-fg);
      border-color: var(--accent);
    }
    .key.correct {
      background: var(--kbd-correct);
      color: #fff;
    }
    .key.wrong {
      background: var(--kbd-wrong);
      color: #fff;
    }
    .key.shift {
      background: #e3e3e3;
    }
    .key.space {
      width: calc(var(--kbd-width) * 6);
    }
    .key.active {
      box-shadow: 0 0 0 3px var(--accent) inset;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 var(--kbd-next); }
      100% { box-shadow: 0 0 0 6px #1976d233; }
    }
    /* Settings Panel */
    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 340px;
      max-width: 100vw;
      height: 100vh;
      background: var(--panel-bg);
      color: var(--panel-fg);
      box-shadow: -2px 0 12px rgba(0,0,0,0.13);
      z-index: 100;
      transform: translateX(100%);
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      padding: 24px 18px 18px 18px;
      overflow-y: auto;
    }
    .settings-panel.open {
      transform: translateX(0);
    }
    .settings-panel h2 {
      margin-top: 0;
      font-size: 1.2em;
      color: var(--accent);
    }
    .settings-panel label {
      display: block;
      margin-top: 12px;
      font-weight: 500;
    }
    .settings-panel input[type="range"] {
      width: 100%;
    }
    .settings-panel select, .settings-panel input[type="number"], .settings-panel input[type="text"] {
      width: 100%;
      padding: 4px 8px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #bbb;
      font-size: 1em;
    }
    .settings-panel .section {
      margin-bottom: 18px;
    }
    .settings-panel .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.3em;
      background: none;
      border: none;
      color: var(--main-fg);
      cursor: pointer;
    }
    /* Levels/Lessons Panel */
    .levels-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.18);
      z-index: 99;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .levels-panel.open {
      display: flex;
    }
    .levels-window {
      background: var(--panel-bg);
      color: var(--panel-fg);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 32px 24px;
      min-width: 340px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .levels-window h2 {
      margin-top: 0;
      color: var(--accent);
    }
    .levels-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .levels-list li {
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .levels-list .lesson-actions button {
      margin-left: 6px;
      background: #eee;
      border: none;
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-size: 0.95em;
    }
    .levels-list .lesson-actions button:hover {
      background: #ddd;
    }
    .levels-window .add-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 1em;
      cursor: pointer;
      margin-top: 10px;
    }
    .levels-window .cancel-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 1.3em;
      color: var(--main-fg);
      cursor: pointer;
    }
    /* Responsive */
    @media (max-width: 700px) {
      .typing-box {
        padding: 12px;
      }
      .keyboard {
        font-size: 1em;
      }
      .settings-panel {
        width: 100vw;
        padding: 18px 8px 8px 8px;
      }
      .levels-window {
        min-width: 90vw;
        padding: 18px 8px;
      }
    }
    /* Themes */
    body.dark {
      --main-bg: #181c24;
      --main-fg: #f4f4f4;
      --panel-bg: #232a36;
      --panel-fg: #f4f4f4;
      --kbd-bg: #232a36;
      --kbd-fg: #f4f4f4;
      --kbd-border: #444;
      --kbd-highlight: #2e3a4d;
      --kbd-next: #1976d2;
      --kbd-correct: #43a047;
      --kbd-wrong: #e53935;
    }
    body.night {
      --main-bg: #0a0a1a;
      --main-fg: #e0e0e0;
      --panel-bg: #181c24;
      --panel-fg: #e0e0e0;
      --kbd-bg: #181c24;
      --kbd-fg: #e0e0e0;
      --kbd-border: #333;
      --kbd-highlight: #222244;
      --kbd-next: #ffd600;
      --kbd-correct: #43a047;
      --kbd-wrong: #e53935;
    }
    body.blue {
      --main-bg: #e3f2fd;
      --main-fg: #0d47a1;
      --panel-bg: #bbdefb;
      --panel-fg: #0d47a1;
      --kbd-bg: #e3f2fd;
      --kbd-fg: #0d47a1;
      --kbd-border: #90caf9;
      --kbd-highlight: #90caf9;
      --kbd-next: #1976d2;
      --kbd-correct: #43a047;
      --kbd-wrong: #e53935;
    }
    body.green {
      --main-bg: #e8f5e9;
      --main-fg: #1b5e20;
      --panel-bg: #c8e6c9;
      --panel-fg: #1b5e20;
      --kbd-bg: #e8f5e9;
      --kbd-fg: #1b5e20;
      --kbd-border: #a5d6a7;
      --kbd-highlight: #a5d6a7;
      --kbd-next: #43a047;
      --kbd-correct: #1976d2;
      --kbd-wrong: #e53935;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">Typing Tutor</div>
    <div class="controls">
      <button id="levelsBtn" title="Levels & Lessons"><span>📚</span> Levels</button>
      <button id="statsBtn" title="Statistics"><span>📊</span></button>
      <button id="fullscreenBtn" title="Fullscreen"><span>⛶</span></button>
      <button id="settingsBtn" class="icon-btn" title="Settings"><span>⚙️</span></button>
    </div>
  </div>
  <div class="main">
    <div class="typing-box">
      <div class="stats">
        <span>Accuracy: <b id="stat-accuracy">100%</b></span>
        <span>Speed: <b id="stat-speed">0</b> WPM</span>
        <span>Errors: <b id="stat-errors">0</b></span>
        <span>Time: <b id="stat-time">0s</b></span>
      </div>
      <div class="typing-text" id="typingText"></div>
      <input type="text" class="typing-input" id="typingInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <div class="actions">
        <button id="restartBtn">Restart Lesson</button>
        <button id="nextLessonBtn">Next Lesson</button>
      </div>
    </div>
    <div class="keyboard-container">
      <div class="keyboard" id="keyboard"></div>
    </div>
    <div id="fingerHint" style="margin-top: 8px; font-size: 1.1em; color: var(--accent);"></div>
  </div>
  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <button class="close-btn" id="closeSettingsBtn" title="Close">&times;</button>
    <h2>Settings</h2>
    <div class="section">
      <label>Mode</label>
      <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="night">Night</option>
        <option value="blue">Blue</option>
        <option value="green">Green</option>
      </select>
    </div>
    <div class="section">
      <label>Font Size</label>
      <input type="range" id="fontSizeRange" min="0.8" max="1.5" step="0.01" value="1.1">
    </div>
    <div class="section">
      <label>Zoom</label>
      <input type="range" id="zoomRange" min="0.8" max="1.5" step="0.01" value="1">
    </div>
    <div class="section">
      <label>Keyboard Size</label>
      <input type="range" id="kbdSizeRange" min="1" max="2" step="0.01" value="1.2">
    </div>
    <div class="section">
      <label>Mistake Sound</label>
      <select id="mistakeSoundSelect">
        <option value="1">Sound 1</option>
        <option value="2">Sound 2</option>
        <option value="3">Sound 3</option>
        <option value="4">Sound 4</option>
        <option value="5">Sound 5</option>
      </select>
    </div>
    <div class="section">
      <label>Typing Text Box Size (Rows)</label>
      <input type="number" id="textBoxRows" min="1" max="5" value="2">
    </div>
    <div class="section">
      <label>Custom Text Import</label>
      <textarea id="customTextImport" rows="2" placeholder="Paste or type your text here..."></textarea>
      <button id="importTextBtn" style="margin-top:6px;">Import</button>
    </div>
    <div class="section">
      <label>Keyboard Layout</label>
      <select id="kbdLayoutSelect">
        <option value="qwerty">QWERTY (EN)</option>
        <option value="azerty">AZERTY (FR)</option>
        <option value="qwertz">QWERTZ (DE)</option>
        <option value="hindi">Hindi (INSCRIPT)</option>
      </select>
    </div>
    <div class="section">
      <label>Keyboard Theme</label>
      <select id="kbdThemeSelect">
        <option value="default">Default</option>
        <option value="blue">Blue</option>
        <option value="green">Green</option>
      </select>
    </div>
    <div class="section">
      <label>Background Music</label>
      <input type="checkbox" id="bgMusicToggle"> Enable
      <input type="range" id="bgMusicVolume" min="0" max="1" step="0.01" value="0.3">
    </div>
    <div class="section">
      <label>Sound On/Off</label>
      <input type="checkbox" id="soundToggle" checked>
    </div>
    <div class="section">
      <label>Session Timer (minutes)</label>
      <input type="number" id="sessionTimer" min="1" max="60" value="5">
      <button id="focusModeBtn" style="margin-top:6px;">Focus Mode</button>
    </div>
    <div class="section">
      <label>Export / Import Data</label>
      <button id="exportDataBtn">Export</button>
      <input type="file" id="importDataInput" style="display:none;">
      <button id="importDataBtn">Import</button>
    </div>
    <div class="section">
      <label>Mobile/Tablet Support</label>
      <span style="font-size:0.95em;">(Auto-enabled on mobile)</span>
    </div>
  </div>
  <!-- Levels/Lessons Panel -->
  <div class="levels-panel" id="levelsPanel">
    <div class="levels-window">
      <button class="cancel-btn" id="closeLevelsBtn">&times;</button>
      <h2>Levels & Lessons</h2>
      <ul class="levels-list" id="levelsList"></ul>
      <button class="add-btn" id="addLevelBtn">+ Add Level</button>
    </div>
  </div>
  <!-- Statistics Modal -->
  <div class="levels-panel" id="statsPanel">
    <div class="levels-window">
      <button class="cancel-btn" id="closeStatsBtn">&times;</button>
      <h2>Lesson Statistics</h2>
      <div id="lessonStats"></div>
    </div>
  </div>
  <!-- Audio for mistake sounds -->
  <audio id="mistakeSound1" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae7e2.mp3"></audio>
  <audio id="mistakeSound2" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae7e2.mp3"></audio>
  <audio id="mistakeSound3" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae7e2.mp3"></audio>
  <audio id="mistakeSound4" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae7e2.mp3"></audio>
  <audio id="mistakeSound5" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae7e2.mp3"></audio>
  <!-- Background Music -->
  <audio id="bgMusic" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae7e2.mp3" loop></audio>
  <script>
    // --- Data ---
    const defaultLevels = [
      {
        name: "Introduction",
        lessons: [
          { name: "Lesson 1", text: "asdf jkl; asdf jkl;" },
          { name: "Lesson 2", text: "asdfg hjkl; asdfg hjkl;" }
        ]
      },
      {
        name: "Beginner",
        lessons: [
          { name: "Lesson 1", text: "man can pan fan" },
          { name: "Lesson 2", text: "the quick brown fox" }
        ]
      },
      {
        name: "Intermediate",
        lessons: [
          { name: "Lesson 1", text: "Typing is a useful skill." },
          { name: "Lesson 2", text: "Practice makes perfect." }
        ]
      },
      {
        name: "Advanced",
        lessons: [
          { name: "Lesson 1", text: "The quick brown fox jumps over the lazy dog." },
          { name: "Lesson 2", text: "Pack my box with five dozen liquor jugs." }
        ]
      },
      {
        name: "Practice",
        lessons: [
          { name: "Lesson 1", text: "Type your own text here!" }
        ]
      }
    ];
    // --- State ---
    let levels = [];
    let currentLevel = 0;
    let currentLesson = 0;
    let lessonStats = {};
    let typingText = "";
    let userInput = "";
    let startTime = null;
    let timerInterval = null;
    let errorCount = 0;
    let errorKeys = {};
    let isShift = false;
    let kbdLayout = "qwerty";
    let kbdTheme = "default";
    let soundOn = true;
    let mistakeSound = 1;
    let bgMusicOn = false;
    let bgMusicVolume = 0.3;
    let focusMode = false;
    let sessionTimer = 5;
    let sessionTimeout = null;
    let fontSize = 1.1;
    let zoom = 1;
    let kbdSize = 1.2;
    let textBoxRows = 2;
    let customText = "";
    let stats = { accuracy: 100, speed: 0, errors: 0, time: 0 };
    let mobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);

    // --- Utility ---
    function saveData() {
      localStorage.setItem("typingTutorLevels", JSON.stringify(levels));
      localStorage.setItem("typingTutorStats", JSON.stringify(lessonStats));
    }
    function loadData() {
      levels = JSON.parse(localStorage.getItem("typingTutorLevels")) || JSON.parse(JSON.stringify(defaultLevels));
      lessonStats = JSON.parse(localStorage.getItem("typingTutorStats")) || {};
    }
    function resetData() {
      levels = JSON.parse(JSON.stringify(defaultLevels));
      lessonStats = {};
      saveData();
    }
    function playMistakeSound() {
      if (!soundOn) return;
      const audio = document.getElementById("mistakeSound" + mistakeSound);
      if (audio) {
        audio.currentTime = 0;
        audio.play();
      }
    }
    function playBgMusic() {
      const audio = document.getElementById("bgMusic");
      audio.volume = bgMusicVolume;
      if (bgMusicOn) {
        audio.play();
      } else {
        audio.pause();
      }
    }
    function stopBgMusic() {
      document.getElementById("bgMusic").pause();
    }
    function getCurrentLesson() {
      return levels[currentLevel]?.lessons?.[currentLesson] || { name: "Custom", text: customText };
    }
    function getLessonKey() {
      return `${currentLevel}-${currentLesson}`;
    }
    function updateStats() {
      const total = typingText.length;
      const correct = userInput.split("").filter((c, i) => c === typingText[i]).length;
      const errors = errorCount;
      const accuracy = total ? Math.max(0, Math.round((correct / total) * 100)) : 100;
      const time = stats.time;
      const words = typingText.split(/\s+/).length;
      const speed = time > 0 ? Math.round((userInput.length / 5) / (time / 60)) : 0;
      stats = { accuracy, speed, errors, time };
      document.getElementById("stat-accuracy").innerHTML = accuracy + "%";
      document.getElementById("stat-speed").innerHTML = speed + " WPM";
      document.getElementById("stat-errors").innerHTML = errors;
      document.getElementById("stat-time").innerHTML = time + "s";
    }
    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      startTime = Date.now();
      timerInterval = setInterval(() => {
        stats.time = Math.floor((Date.now() - startTime) / 1000);
        updateStats();
      }, 1000);
    }
    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }
    function startSessionTimer() {
      if (sessionTimeout) clearTimeout(sessionTimeout);
      if (sessionTimer > 0) {
        sessionTimeout = setTimeout(() => {
          alert("Session time over!");
          stopTimer();
        }, sessionTimer * 60 * 1000);
      }
    }
    function stopSessionTimer() {
      if (sessionTimeout) clearTimeout(sessionTimeout);
      sessionTimeout = null;
    }
    function setTheme(theme) {
      document.body.className = theme;
    }
    function setFontSize(size) {
      document.documentElement.style.setProperty("--font-size", size + "em");
    }
    function setZoom(z) {
      document.documentElement.style.setProperty("--zoom", z);
    }
    function setKbdSize(size) {
      document.documentElement.style.setProperty("--kbd-size", size + "em");
    }
    function setTextBoxRows(rows) {
      document.getElementById("typingText").style.minHeight = (rows * 1.5) + "em";
    }
    function setKbdTheme(theme) {
      document.body.classList.remove("blue", "green");
      if (theme !== "default") document.body.classList.add(theme);
    }
    function setKbdLayout(layout) {
      kbdLayout = layout;
      renderKeyboard();
    }
    function setMistakeSound(n) {
      mistakeSound = n;
    }
    function setSoundOn(on) {
      soundOn = on;
    }
    function setBgMusicOn(on) {
      bgMusicOn = on;
      playBgMusic();
    }
    function setBgMusicVolume(vol) {
      bgMusicVolume = vol;
      playBgMusic();
    }
    function setFocusMode(on) {
      focusMode = on;
      if (on) {
        document.querySelector(".header").style.display = "none";
        document.querySelector(".keyboard-container").style.display = "none";
        document.getElementById("fingerHint").style.display = "none";
        document.body.style.background = "#111";
      } else {
        document.querySelector(".header").style.display = "";
        document.querySelector(".keyboard-container").style.display = "";
        document.getElementById("fingerHint").style.display = "";
        document.body.style.background = "";
      }
    }
    // --- Keyboard Layouts ---
    const layouts = {
      qwerty: [
        ["`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "Backspace"],
        ["Tab", "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\"],
        ["CapsLock", "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'", "Enter"],
        ["Shift", "z", "x", "c", "v", "b", "n", "m", ",", ".", "/", "Shift"],
        ["Space"]
      ],
      azerty: [
        ["²", "&", "é", "\"", "'", "(", "-", "è", "_", "ç", "à", ")", "=", "Backspace"],
        ["Tab", "a", "z", "e", "r", "t", "y", "u", "i", "o", "p", "^", "$", "*"],
        ["CapsLock", "q", "s", "d", "f", "g", "h", "j", "k", "l", "m", "ù", "Enter"],
        ["Shift", "w", "x", "c", "v", "b", "n", ",", ";", ":", "!", "Shift"],
        ["Space"]
      ],
      qwertz: [
        ["^", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "ß", "´", "Backspace"],
        ["Tab", "q", "w", "e", "r", "t", "z", "u", "i", "o", "p", "ü", "+", "#"],
        ["CapsLock", "a", "s", "d", "f", "g", "h", "j", "k", "l", "ö", "ä", "Enter"],
        ["Shift", "y", "x", "c", "v", "b", "n", "m", ",", ".", "-", "Shift"],
        ["Space"]
      ],
      hindi: [
        ["\u094A", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "Backspace"],
        ["Tab", "\u094C", "\u0948", "\u093E", "\u0940", "\u0942", "\u092C", "\u0939", "\u0917", "\u0926", "\u091C", "\u0921", "\u093C", "\\"],
        ["CapsLock", "\u094B", "\u0947", "\u094D", "\u093F", "\u0941", "\u092A", "\u0930", "\u0915", "\u0924", "\u091A", "\u091F", "Enter"],
        ["Shift", "\u0949", "\u0902", "\u092E", "\u0928", "\u0935", "\u0932", "\u0938", ",", ".", "/", "Shift"],
        ["Space"]
      ]
    };
    // --- Keyboard Rendering ---
    function renderKeyboard() {
      const kbd = document.getElementById("keyboard");
      kbd.innerHTML = "";
      const layout = layouts[kbdLayout] || layouts.qwerty;
      let nextChar = typingText[userInput.length] || "";
      let needShift = false;
      if (nextChar && /[A-Z!@#$%^&*()_+{}|:"<>?~]/.test(nextChar)) needShift = true;
      layout.forEach((row, rowIdx) => {
        const rowDiv = document.createElement("div");
        rowDiv.className = "keyboard-row";
        row.forEach(key => {
          const keyDiv = document.createElement("div");
          keyDiv.className = "key";
          keyDiv.textContent = key.length === 1 && isShift ? key.toUpperCase() : key;
          keyDiv.dataset.key = key;
          // Highlight next char
          if (key.length === 1 && key.toLowerCase() === nextChar?.toLowerCase()) {
            keyDiv.classList.add("next");
          }
          // Highlight shift if needed
          if ((key === "Shift" || key === "CapsLock") && needShift) {
            keyDiv.classList.add("highlight");
          }
          // Touch support
          keyDiv.addEventListener("touchstart", e => {
            e.preventDefault();
            handleVirtualKey(key);
          });
          // Mouse support
          keyDiv.addEventListener("mousedown", e => {
            e.preventDefault();
            handleVirtualKey(key);
          });
          rowDiv.appendChild(keyDiv);
        });
        kbd.appendChild(rowDiv);
      });
    }
    // --- Finger Prediction ---
    const fingerMap = {
      qwerty: {
        "q": "Left Pinky", "a": "Left Pinky", "z": "Left Pinky",
        "w": "Left Ring", "s": "Left Ring", "x": "Left Ring",
        "e": "Left Middle", "d": "Left Middle", "c": "Left Middle",
        "r": "Left Index", "f": "Left Index", "v": "Left Index", "t": "Left Index", "g": "Left Index", "b": "Left Index",
        "y": "Right Index", "h": "Right Index", "n": "Right Index", "u": "Right Index", "j": "Right Index", "m": "Right Index",
        "i": "Right Middle", "k": "Right Middle", ",": "Right Middle",
        "o": "Right Ring", "l": "Right Ring", ".": "Right Ring",
        "p": "Right Pinky", ";": "Right Pinky", "/": "Right Pinky", "[": "Right Pinky", "]": "Right Pinky", "'": "Right Pinky",
        " ": "Thumb", "Shift": "Left/Right Pinky"
      }
    };
    function getFingerHint(char) {
      if (!char) return "";
      let map = fingerMap[kbdLayout] || fingerMap.qwerty;
      let c = char.toLowerCase();
      let finger = map[c] || "Any";
      if (char === char.toUpperCase() && /[A-Z]/.test(char)) {
        return `Use <b>Left Pinky</b> for <b>Shift</b> + <b>${char}</b> (${finger})`;
      }
      if (char === " ") return "Use <b>Thumb</b> for <b>Space</b>";
      return `Use <b>${finger}</b> for <b>${char}</b>`;
    }
    // --- Typing Text Rendering ---
    function renderTypingText() {
      const textDiv = document.getElementById("typingText");
      textDiv.innerHTML = "";
      for (let i = 0; i < typingText.length; i++) {
        const span = document.createElement("span");
        span.textContent = typingText[i];
        if (i < userInput.length) {
          if (userInput[i] === typingText[i]) span.className = "correct";
          else span.className = "wrong";
        } else if (i === userInput.length) {
          span.className = "current";
        }
        textDiv.appendChild(span);
      }
      document.getElementById("fingerHint").innerHTML = getFingerHint(typingText[userInput.length]);
    }
    // --- Typing Logic ---
    function handleInput(e) {
      let val = e.target.value;
      if (val.length > typingText.length) val = val.slice(0, typingText.length);
      let lastChar = val[val.length - 1];
      if (lastChar && typingText[val.length - 1] !== lastChar) {
        errorCount++;
        errorKeys[lastChar] = (errorKeys[lastChar] || 0) + 1;
        playMistakeSound();
      }
      userInput = val;
      renderTypingText();
      updateStats();
      renderKeyboard();
      if (userInput.length === 1 && !startTime) {
        startTimer();
        startSessionTimer();
      }
      if (userInput.length === typingText.length) {
        stopTimer();
        stopSessionTimer();
        lessonStats[getLessonKey()] = { ...stats, errorKeys: { ...errorKeys } };
        saveData();
      }
    }
    function handleVirtualKey(key) {
      if (key === "Backspace") {
        userInput = userInput.slice(0, -1);
      } else if (key === "Space") {
        userInput += " ";
      } else if (key === "Tab") {
        userInput += "\t";
      } else if (key === "Enter") {
        userInput += "\n";
      } else if (key === "Shift") {
        isShift = !isShift;
        renderKeyboard();
        return;
      } else if (key.length === 1) {
        userInput += isShift ? key.toUpperCase() : key;
        isShift = false;
      }
      document.getElementById("typingInput").value = userInput;
      renderTypingText();
      updateStats();
      renderKeyboard();
    }
    // --- Levels/Lessons UI ---
    function renderLevelsPanel() {
      const list = document.getElementById("levelsList");
      list.innerHTML = "";
      levels.forEach((level, lidx) => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${level.name}</b>`;
        // Level actions
        const levelActions = document.createElement("span");
        levelActions.className = "lesson-actions";
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editLevel(lidx);
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = () => { if (confirm("Delete level?")) { levels.splice(lidx, 1); saveData(); renderLevelsPanel(); } };
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset";
        resetBtn.onclick = () => { if (confirm("Reset level?")) { levels[lidx] = JSON.parse(JSON.stringify(defaultLevels[lidx])); saveData(); renderLevelsPanel(); } };
        levelActions.append(editBtn, delBtn, resetBtn);
        li.appendChild(levelActions);
        // Lessons
        const ul = document.createElement("ul");
        ul.style.listStyle = "circle";
        ul.style.marginLeft = "18px";
        level.lessons.forEach((lesson, idx) => {
          const lili = document.createElement("li");
          // Yahan par class aur data attributes add karein
          lili.innerHTML = `<span class="lesson-select" data-level="${lidx}" data-lesson="${idx}" style="cursor:pointer;">${lesson.name}</span>`;
          // Lesson actions
          const lessonActions = document.createElement("span");
          lessonActions.className = "lesson-actions";
          const editLBtn = document.createElement("button");
          editLBtn.textContent = "Edit";
          editLBtn.onclick = () => editLesson(lidx, idx);
          const delLBtn = document.createElement("button");
          delLBtn.textContent = "Delete";
          delLBtn.onclick = () => { if (confirm("Delete lesson?")) { levels[lidx].lessons.splice(idx, 1); saveData(); renderLevelsPanel(); } };
          const resetLBtn = document.createElement("button");
          resetLBtn.textContent = "Reset";
          resetLBtn.onclick = () => { if (confirm("Reset lesson?")) { levels[lidx].lessons[idx] = JSON.parse(JSON.stringify(defaultLevels[lidx].lessons[idx])); saveData(); renderLevelsPanel(); } };
          lessonActions.append(editLBtn, delLBtn, resetLBtn);
          lili.appendChild(lessonActions);
          ul.appendChild(lili);
        });
        // Add lesson
        const addLessonBtn = document.createElement("button");
        addLessonBtn.textContent = "+ Add Lesson";
        addLessonBtn.onclick = () => addLesson(lidx);
        ul.appendChild(addLessonBtn);
        li.appendChild(ul);
        list.appendChild(li);
      });
    }

    // Event delegation for lesson select
    document.getElementById("levelsList").onclick = function(e) {
      const target = e.target;
      if (target.classList.contains("lesson-select")) {
        const lidx = parseInt(target.dataset.level);
        const idx = parseInt(target.dataset.lesson);
        selectLesson(lidx, idx);
      }
    };

    function selectLesson(lidx, idx) {
      currentLevel = lidx;
      currentLesson = idx;
      loadLesson();
      document.getElementById("levelsPanel").classList.remove("open");
    }
    function addLevel() {
      const name = prompt("Level name?");
      if (name) {
        levels.push({ name, lessons: [] });
        saveData();
        renderLevelsPanel();
      }
    }
    function editLevel(lidx) {
      const name = prompt("Edit level name:", levels[lidx].name);
      if (name) {
        levels[lidx].name = name;
        saveData();
        renderLevelsPanel();
      }
    }
    function addLesson(lidx) {
      const name = prompt("Lesson name?");
      const text = prompt("Lesson text?");
      if (name && text) {
        levels[lidx].lessons.push({ name, text });
        saveData();
        renderLevelsPanel();
      }
    }
    function editLesson(lidx, idx) {
      const name = prompt("Edit lesson name:", levels[lidx].lessons[idx].name);
      const text = prompt("Edit lesson text:", levels[lidx].lessons[idx].text);
      if (name && text) {
        levels[lidx].lessons[idx] = { name, text };
        saveData();
        renderLevelsPanel();
      }
    }
    // --- Lesson Loading ---
    function loadLesson() {
      const lesson = getCurrentLesson();
      typingText = lesson.text;
      userInput = "";
      errorCount = 0;
      errorKeys = {};
      stats = { accuracy: 100, speed: 0, errors: 0, time: 0 };
      document.getElementById("typingInput").value = "";
      renderTypingText();
      updateStats();
      renderKeyboard();
      stopTimer();
      stopSessionTimer();
      document.getElementById("typingInput").focus();
    }
    // --- Statistics Panel ---
    function renderStatsPanel() {
      const div = document.getElementById("lessonStats");
      div.innerHTML = "";
      Object.keys(lessonStats).forEach(key => {
        const stat = lessonStats[key];
        div.innerHTML += `<div>
          <b>Lesson ${key}:</b> Accuracy: ${stat.accuracy}%, Speed: ${stat.speed} WPM, Errors: ${stat.errors}, Time: ${stat.time}s
          <br>
          <span style="font-size:0.95em;">Error Keys: ${Object.entries(stat.errorKeys || {}).map(([k, v]) => `${k}: ${v}`).join(", ")}</span>
        </div><hr>`;
      });
    }
    // --- Fullscreen ---
    function openFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }
    // --- Event Listeners ---
    document.getElementById("settingsBtn").onclick = () => {
      document.getElementById("settingsPanel").classList.add("open");
    };
    document.getElementById("closeSettingsBtn").onclick = () => {
      document.getElementById("settingsPanel").classList.remove("open");
    };
    document.getElementById("levelsBtn").onclick = () => {
      renderLevelsPanel();
      document.getElementById("levelsPanel").classList.add("open");
    };
    document.getElementById("closeLevelsBtn").onclick = () => {
      document.getElementById("levelsPanel").classList.remove("open");
    };
    document.getElementById("statsBtn").onclick = () => {
      renderStatsPanel();
      document.getElementById("statsPanel").classList.add("open");
    };
    document.getElementById("closeStatsBtn").onclick = () => {
      document.getElementById("statsPanel").classList.remove("open");
    };
    document.getElementById("fullscreenBtn").onclick = openFullscreen;
    document.getElementById("restartBtn").onclick = loadLesson;
    document.getElementById("nextLessonBtn").onclick = () => {
      if (levels[currentLevel].lessons[currentLesson + 1]) {
        currentLesson++;
        loadLesson();
      } else if (levels[currentLevel + 1]) {
        currentLevel++;
        currentLesson = 0;
        loadLesson();
      } else {
        alert("No more lessons!");
      }
    };
    document.getElementById("fontSizeRange").oninput = e => setFontSize(e.target.value);
    document.getElementById("zoomRange").oninput = e => setZoom(e.target.value);
    document.getElementById("kbdSizeRange").oninput = e => setKbdSize(e.target.value);
    document.getElementById("themeSelect").onchange = e => setTheme(e.target.value);
    document.getElementById("kbdLayoutSelect").onchange = e => setKbdLayout(e.target.value);
    document.getElementById("kbdThemeSelect").onchange = e => setKbdTheme(e.target.value);
    document.getElementById("mistakeSoundSelect").onchange = e => setMistakeSound(e.target.value);
    document.getElementById("soundToggle").onchange = e => setSoundOn(e.target.checked);
    document.getElementById("bgMusicToggle").onchange = e => setBgMusicOn(e.target.checked);
    document.getElementById("bgMusicVolume").oninput = e => setBgMusicVolume(e.target.value);
    document.getElementById("textBoxRows").oninput = e => setTextBoxRows(e.target.value);
    document.getElementById("sessionTimer").oninput = e => sessionTimer = e.target.value;
    document.getElementById("focusModeBtn").onclick = () => setFocusMode(!focusMode);
    document.getElementById("addLevelBtn").onclick = addLevel;
    document.getElementById("importTextBtn").onclick = () => {
      const txt = document.getElementById("customTextImport").value;
      if (txt) {
        customText = txt;
        typingText = customText;
        userInput = "";
        errorCount = 0;
        errorKeys = {};
        stats = { accuracy: 100, speed: 0, errors: 0, time: 0 };
        document.getElementById("typingInput").value = "";
        renderTypingText();
        updateStats();
        renderKeyboard();
        stopTimer();
        stopSessionTimer();
        document.getElementById("settingsPanel").classList.remove("open");
      }
    };
    document.getElementById("exportDataBtn").onclick = () => {
      const data = { levels, lessonStats };
      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "typing_tutor_data.json";
      a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById("importDataBtn").onclick = () => {
      document.getElementById("importDataInput").click();
    };
    document.getElementById("importDataInput").onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.levels && data.lessonStats) {
            levels = data.levels;
            lessonStats = data.lessonStats;
            saveData();
            alert("Data imported!");
          }
        } catch (err) {
          alert("Invalid data file.");
        }
      };
      reader.readAsText(file);
    };
    // --- Typing Input ---
    document.getElementById("typingInput").addEventListener("input", handleInput);
    // --- Close settings on body click ---
    document.body.addEventListener("mousedown", e => {
      if (!e.target.closest(".settings-panel") && !e.target.closest("#settingsBtn")) {
        document.getElementById("settingsPanel").classList.remove("open");
      }
      if (!e.target.closest(".levels-window") && !e.target.closest("#levelsBtn")) {
        document.getElementById("levelsPanel").classList.remove("open");
      }
      if (!e.target.closest(".levels-window") && !e.target.closest("#statsBtn")) {
        document.getElementById("statsPanel").classList.remove("open");
      }
    });
    // --- Mobile/Tablet Support ---
    if (mobile) {
      document.getElementById("typingInput").type = "text";
      document.getElementById("typingInput").style.opacity = 1;
      document.getElementById("typingInput").style.position = "static";
      document.getElementById("typingInput").style.width = "100%";
      document.getElementById("typingInput").style.fontSize = "1.2em";
      document.getElementById("typingInput").focus();
    }
    // --- Init ---
    function init() {
      loadData();
      setTheme("light");
      setFontSize(fontSize);
      setZoom(zoom);
      setKbdSize(kbdSize);
      setTextBoxRows(textBoxRows);
      setKbdLayout(kbdLayout);
      setKbdTheme(kbdTheme);
      setMistakeSound(mistakeSound);
      setSoundOn(soundOn);
      setBgMusicOn(bgMusicOn);
      setBgMusicVolume(bgMusicVolume);
      loadLesson();
    }
    window.onload = init;
  </script>
</body>
</html>